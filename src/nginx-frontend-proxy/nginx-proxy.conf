# Upstream clusters (Mapped from Envoy's clusters)
# Each upstream corresponds to an Envoy cluster

upstream opentelemetry_collector_grpc {
    server otel-collector:4317;
}

upstream opentelemetry_collector_http {
    server otel-collector:4318;
}

upstream frontend {
    server frontend:8080;
}

upstream image_provider {
    server image-provider:8081;
}

upstream flagservice {
    server flagd:8013;
}

upstream flagd_ui {
    server flagd-ui:4000;
}

upstream loadgen {
    server load-generator:8089;
}

upstream grafana {
    server grafana:3000;
}

upstream jaeger {
    server jaeger:16686;
}

# Server block (Mapped from Envoy's listener)

server {
    listen 8080;
    server_name _;


    otel_trace on;
    # /loadgen -> loadgen upstream
    location /loadgen {
        otel_trace_context propagate;
        otel_span_name "$request_method $uri";
        proxy_pass http://loadgen/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        otel_span_attr "request.id" $http_x_request_id;
        # proxy_set_header traceparent $otel_trace_id;
        # proxy_set_header tracestate $otel_trace_state;
        rewrite ^/loadgen/?(.*)$ /$1 break;
    }

    # /otlp-http/ -> opentelemetry_collector_http upstream
    location /otlp-http/ {
        otel_trace_context propagate;
        otel_span_name "$request_method $uri";
        proxy_pass http://opentelemetry_collector_http/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        otel_span_attr "request.id" $http_x_request_id;
        # proxy_set_header traceparent $otel_trace_id;
        # proxy_set_header tracestate $otel_trace_state;
        rewrite ^/otlp-http/?(.*)$ /$1 break;
    }

    # /jaeger -> jaeger upstream
    location /jaeger {
        otel_trace_context propagate;
        otel_span_name "$request_method $uri";
        proxy_pass http://jaeger;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        otel_span_attr "request.id" $http_x_request_id;
        proxy_set_header traceparent $otel_trace_id;
        # proxy_set_header tracestate $otel_trace_state;
    }

    # /grafana -> grafana upstream
    location /grafana {
        otel_trace_context propagate;
        otel_span_name "$request_method $uri";
        proxy_pass http://grafana;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        otel_span_attr "request.id" $http_x_request_id;
        proxy_set_header traceparent $otel_trace_id;
        # proxy_set_header tracestate $otel_trace_state;
    }

    # /images/ -> image_provider upstream
    location /images/ {
        otel_trace_context propagate;
        otel_span_name "$request_method $uri";
        proxy_pass http://image_provider/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        otel_span_attr "request.id" $http_x_request_id;
        # proxy_set_header traceparent $otel_trace_id;
        # proxy_set_header tracestate $otel_trace_state;
        rewrite ^/images/?(.*)$ /$1 break;
    }

    # /flagservice/ -> flagservice upstream
    location /flagservice/ {
        otel_trace_context propagate;
        otel_span_name "$request_method $uri";
        proxy_pass http://flagservice/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        otel_span_attr "request.id" $http_x_request_id;
        # proxy_set_header traceparent $otel_trace_id;
        rewrite ^/flagservice/?(.*)$ /$1 break;
        # No timeout (timeout: 0s in Envoy)
        proxy_read_timeout 0;
    }

    #feature -> flagd_ui upstream
    location /feature {
        proxy_pass http://flagd_ui;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        otel_span_attr "request.id" $http_x_request_id;
        otel_trace_context propagate;
        # otel_span_name "$request_method $uri";
        # proxy_set_header traceparent $otel_trace_id;
    }

    # catch-all ("/") -> frontend upstream
    location / {
        # otel_trace $otel_parent_sampled;
        otel_trace_context propagate;
        otel_span_name "$request_method $uri";
        proxy_pass http://frontend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        otel_span_attr "request.id" $http_x_request_id;
        # proxy_set_header traceparent $otel_trace_id;
        # proxy_set_header tracestate $otel_trace_state;
    }
}